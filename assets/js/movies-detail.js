const moviesData = {
            TopGun: [{
                title: "Top Gun",
                image: "https://filman.cc/public/static/poster/big/30091.jpg",
                year: "1986",
                genre: "Akcja Romans Sensacyjny",
                link: "https://upstream.to/embed-1ferv58rjpm7.html"
            }, {
                title: "Top Gun: Maverick",
                image: "https://filman.cc/public/static/poster/big/56188.jpg",
                year: "2022",
                genre: "Akcja",
                link: "https://sbchill.com/embed-2zh26ul71s0o.html"
            }],
            _28Dni_Tygodni_Pozniej: [{
                title: "28 dni później / 28 Days Later...",
                image: "https://filman.cc/public/static/poster/big/8161.jpg",
                year: "2002",
                genre: "Horror",
                link: "https://ebd.cda.pl/740x475/931632386"
            }, {
                title: "28 tygodni później / 28 Weeks Later",
                image: "https://filman.cc/public/static/poster/big/22714.jpg",
                year: "2007",
                genre: "Horror",
                link: "https://ebd.cda.pl/740x475/6559220f9"
            }],
            _2012: [{
                title: "2012",
                image: "https://fwcdn.pl/fpo/39/13/433913/7695238.3.jpg",
                year: "2009",
                genre: "Sci-fi Katastroficzny",
                link: "https://tummulerviolableness.com/e/ecwl2wid2zfr"
            }],
            BękartyWojny: [{
                title: "Bękarty wojny",
                image: "https://fwcdn.pl/fpo/77/47/137747/7276639.3.jpg",
                year: "2009",
                genre: "Wojenny",
                link: "https://tummulerviolableness.com/e/lr0om7waukcm"
            }],
            CzłowiekZBlizną: [{
                title: "Człowiek z blizną",
                image: "https://fwcdn.pl/fpo/48/33/4833/6935904.3.jpg",
                year: "1983",
                genre: "Dramat Gangsterski",
                link: "https://tummulerviolableness.com/e/ugyy55exwf4b"
            }],
            Doomsday: [{
                title: "Doomsday",
                image: "https://m.media-amazon.com/images/I/81cT24c+EEL._RI_.jpg",
                year: "2008",
                genre: "Akcja Sci-Fi",
                link: "https://vidoza.net/embed-fydvb1zb14ms.html"
            }],
            GodzinySzczytu: [{
                title: "Godziny Szczytu",
                image: "https://fwcdn.pl/fpo/00/59/59/6922212.3.jpg",
                year: "1998",
                genre: "Akcja Komedia Kryminalna",
                link: "https://ebd.cda.pl/740x475/8369916c5"
            }, {
                title: "Godziny Szczytu 2",
                image: "https://fwcdn.pl/fpo/06/25/30625/7518081.3.jpg",
                year: "2001",
                genre: "Akcja Komedia Kryminalna",
                link: "https://tummulerviolableness.com/e/ir10bt6mc0od"
            }, {
                title: "Godziny Szczytu 3",
                image: "https://fwcdn.pl/fpo/17/52/101752/7183742.3.jpg",
                year: "1992",
                genre: "Akcja Komedia Kryminalna",
                link: "https://tummulerviolableness.com/e/fhky0ff7eg8p"
            }],
            XXX_Trylogia: [{
                title: "xXx",
                image: "https://filman.cc/public/static/poster/big/788.jpg",
                year: "2002",
                genre: "Akcja",
                link: "https://ebd.cda.pl/740x475/9799776b8"
            }, {
                title: "xXx 2: Następny poziom",
                image: "https://filman.cc/public/static/poster/big/1066.jpg",
                year: "2005",
                genre: "Akcja",
                link: "https://streamtape.com/e/RW9dqQ4qJKcdvQd/xXx_2-_Następny_poziom___xXx-_State_of_the_Union_(2005).mp4"
            }, {
                title: "xXx 3: Następny poziom",
                image: "https://filman.cc/public/static/poster/big/794.jpg",
                year: "2017",
                genre: "Akcja",
                link: "https://upstream.to/embed-kg582gkc8owt.html"
            }],
            ZielonaMila: [{
                title: "Zielona Mila",
                image: "https://fwcdn.pl/fpo/08/62/862/7517878.3.jpg",
                year: "1999",
                genre: "Dramat",
                link: "https://www.cda.pl/video/1558172203"
            }],
            SzeregowiecRyan: [{
                title: "Szeregowiec Ryan",
                image: "https://filman.cc/public/static/poster/big/5160.jpg",
                year: "1998",
                genre: "Wojenny",
                link: "https://upstream.to/embed-08tf47alon8c.html"
            }],
            ZabójczaBroń: [{
                title: "Zabójcza broń",
                image: "https://fwcdn.pl/fpo/13/08/1308/7059259.3.jpg",
                year: "1987",
                genre: "Komedia Kryminalna",
                link: "https://streamtape.com/e/WpGxDePWddfblP0"
            }, {
                title: "Zabójcza broń 2",
                image: "https://fwcdn.pl/fpo/13/09/1309/7059260.3.jpg",
                year: "1989",
                genre: "Komedia Kryminalna",
                link: "https://streamtape.com/e/ZD3dz3ev7oHq8oD"
            }, {
                title: "Zabójcza broń 3",
                image: "https://fwcdn.pl/fpo/13/10/1310/7749098.3.jpg",
                year: "1992",
                genre: "Komedia Kryminalna",
                link: "https://vidoza.net/embed-hnfue51vuyzt.html"
            }, {
                title: "Zabójcza broń 4",
                image: "https://fwcdn.pl/fpo/02/03/203/7059263.3.jpg",
                year: "1998",
                genre: "Komedia Kryminalna",
                link: "https://streamtape.com/e/6XAQwMAkxks9BVq"
            }],
            Uncharted: [{
                title: "Uncharted",
                image: "https://filman.cc/public/static/poster/big/55523.jpg",
                year: "2022",
                genre: "Akcja, Przygodowy",
                link: "https://vidoza.net/embed-myof11ouvc55.html"
            }],
            TowerHeistZemstaCieciów: [{
                title: "Tower Heist Zemsta cieciów",
                image: "https://fwcdn.pl/fpo/82/07/288207/7401836.3.jpg",
                year: "2011",
                genre: "Akcja,Komedia kryminalna",
                link: "https://tummulerviolableness.com/e/lr0om7waukcm"
            }],
            Taxi: [{
                    title: "Taxi",
                    image: "https://fwcdn.pl/fpo/07/27/727/6900934.3.jpg",
                    year: "1998",
                    genre: "Komedia Kryminalna",
                    link: "https://tummulerviolableness.com/e/33donik8qfqf"
                }, {
                    title: "Taxi 2",
                    image: "https://fwcdn.pl/fpo/00/69/10069/7519121.3.jpg",
                    year: "2001",
                    genre: "Komedia Kryminalna",
                    link: "https://streamtape.com/e/8Dy1aKKYKZfjAd"
                }, {
                    title: "Taxi 3",
                    image: "https://fwcdn.pl/fpo/41/98/34198/7518096.3.jpg",
                    year: "2003",
                    genre: "Komedia Kryminalna",
                    link: "https://tummulerviolableness.com/e/z7ij8x1bq8yn"
                }, {
                    title: "Taxi 4",
                    image: "https://fwcdn.pl/fpo/87/99/338799/7530407.3.jpg",
                    year: "2007",
                    genre: "Komedia Kryminalna",
                    link: "https://streamtape.com/e/yAJ762p60Wf1pw3"
                }, {
                    title: "Taxi 5",
                    image: "https://filman.cc/public/static/poster/big/1696.jpg",
                    year: "2018",
                    genre: "Komedia Kryminalna",
                    link: "https://vtube.network/embed-53yz5btc7j0i.html"
                },

            ],
            SzybcyIWściekli: [{
                title: "Szybcy i Wściekli",
                image: "https://filman.cc/public/static/poster/big/29.jpg",
                year: "2001",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-pn6efruftbn6.html"
            }, {
                title: "Za Szybcy i Wściekli",
                image: "https://filman.cc/public/static/poster/big/37.jpg",
                year: "2003",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-skrvj87xbjee.html"
            }, {
                title: "Szybko i wściekle",
                image: "https://filman.cc/public/static/poster/big/27.jpg",
                year: "2009",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-17fqcy3gvhp2.html"
            }, {
                title: "Szybcy i Wściekli V",
                image: "https://filman.cc/public/static/poster/big/20.jpg",
                year: "2011",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-o9pxhhpk8mpu.html"
            }, {
                title: "Szybcy i Wściekli 6",
                image: "https://filman.cc/public/static/poster/big/23.jpg",
                year: "2013",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-f2lo9v9jmbpk.html"
            }, {
                title: "Szybcy i Wściekli: Tokyo Drift",
                image: "https://filman.cc/public/static/poster/big/26.jpg",
                year: "2006",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-9ac14h5wad3p.html"
            }, {
                title: "Szybcy i Wściekli 7",
                image: "https://filman.cc/public/static/poster/big/44.jpg",
                year: "2015",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-79p0o882uky4.html"
            }, {
                title: "Szybcy i Wściekli 8",
                image: "https://filman.cc/public/static/poster/big/43.jpg",
                year: "2017",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://ebd.cda.pl/740x475/65669009e?wersja=720p&t=1"
            }, {
                title: "Szybcy i wściekli: Hobbs i Shaw",
                image: "https://filman.cc/public/static/poster/big/10468.jpg",
                year: "2019",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://streamtape.com/e/o2zRJPg2JaHJewK/Szybcy_i_w%C5%9Bciekli-_Hobbs_i_Shaw___Fast_%26amp%3B_Furious_presents-_Hobbs_%26amp%3B_Shaw_%282019%29_.mp4"
            }, {
                title: "Szybcy i Wściekli 9",
                image: "https://filman.cc/public/static/poster/big/53139.jpg",
                year: "2021",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-5we9to52tv0v.html"
            }],
            OjciecChrzestny: [{
                title: "Ojciec chrzestny",
                image: "https://fwcdn.pl/fpo/10/89/1089/7196615.3.jpg",
                year: "1972",
                genre: "Dramat Gangsterski",
                link: "https://streamtape.com/e/jpqgQaX7KJhz0J2"
            }, {
                title: "Ojciec chrzestny 2",
                image: "https://fwcdn.pl/fpo/10/90/1090/7196616.3.jpg",
                year: "1974",
                genre: "Dramat Gangsterski",
                link: "https://streamtape.com/e/MoDjW77KxXUm7GZ"
            }, {
                title: "Ojciec chrzestny 3",
                image: "https://fwcdn.pl/fpo/10/91/1091/7196617.3.jpg",
                year: "1990",
                genre: "Dramat Gangsterski",
                link: "https://ebd.cda.pl/740x475/66544132c"
            }],
            Reacher: [{
                title: "[s01e01] Welcome to Margrave",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-rr9n87ugxe7x.html"
            }, {
                title: "[s01e02] First Dance",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-t7aj5xnw5g4x.html"
            }, {
                title: "[s01e03] Spoonful",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-l4wvfh63c6qw.html"
            }, {
                title: "[s01e04] In a Tree",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-ysxq61uq8jfh.html"
            }, {
                title: "[s01e05] No Apologies",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://vidoza.net/embed-9orpjj6tqukv.html"
            }, {
                title: "[s01e06] Papier",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-fl87z9rfcr9a.html"
            }, {
                title: "[s01e07] Reacher Said Nothing",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-wrtlvxj3tcl0.html"
            }, {
                title: "[s01e08] Pie",
                image: "https://fwcdn.pl/fpo/59/87/875987/7986413.3.jpg",
                year: "2022",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-td0e9u1v5oex.html"
            }],
            Niezniszczalni: [{
                title: "Niezniszczalni / The Expendables",
                image: "https://filman.cc/public/static/poster/big/31.jpg",
                year: "2010",
                genre: "Akcja",
                link: "https://vidoza.net/embed-hkbmwoze5cnd.html"
            }, {
                title: "Niezniszczalni 2 / The Expendables 2",
                image: "https://filman.cc/public/static/poster/big/5619.jpg",
                year: "2012",
                genre: "Akcja",
                link: "https://upstream.to/embed-dedncyvcuvf6.html"
            }, {
                title: "Niezniszczalni 3 / The Expendables 3",
                image: "https://filman.cc/public/static/poster/big/549.jpg",
                year: "2014",
                genre: "Akcja",
                link: "https://upstream.to/embed-l4159pqbpk1l.html"
            }],
            NaZachodzieBezZmian: [{
                title: "Na Zachodzie bez zmian / Im Westen nichts Neues",
                image: "https://filman.cc/public/static/poster/big/57331.jpg",
                year: "2022",
                genre: "Dramat Wojenny",
                link: "https://streamhide.to/e/4ey821lmcm8p"
            }],
            JohnWick: [{
                title: "John Wick 1 Charapter One",
                image: "https://filman.cc/public/static/poster/big/497.jpg",
                year: "2014",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-8wzr9g6sej4j.html"
            }, {
                title: "John Wick 2 / John Wick: Chapter Two",
                image: "https://filman.cc/public/static/poster/big/57.jpg",
                year: "2017",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://upstream.to/embed-mwl0jkkmew4l.html"
            }, {
                title: "John Wick 3 / John Wick: Chapter 3 - Parabellum",
                image: "https://filman.cc/public/static/poster/big/8617.jpg",
                year: "2019",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://dood.yt/e/cw91xhr2q65d"
            }, {
                title: "John Wick 4 (ENG Napisy-PL)",
                image: "https://filman.cc/public/static/poster/big/58714.jpg",
                year: "2023",
                genre: "Akcja, Kryminał, Thriller",
                link: "https://voe.sx/e/sgy24h8p6xlo"
            }],
            JasFasola: [{
                title: "Jaś Fasola: Nadciąga totalny kataklizm / Bean",
                image: "https://assets.upflix.pl/media/plakat/1997/bean__300_427.jpg",
                year: "1997",
                genre: "Komedia",
                link: "https://ebd.cda.pl/740x475/1419273be"
            }, {
                title: "Wakacje Jasia Fasoli / Mr. Bean's Holiday",
                image: "https://filman.cc/public/static/poster/big/4927.jpg",
                year: "2007",
                genre: "Familijny, Komedia",
                link: "https://dood.yt/e/iczo8t416hl9"
            }],
            HotShots: [{
                title: "Hot Shots!",
                image: "https://filman.cc/public/static/poster/big/7780.jpg",
                year: "1991",
                genre: "Akcja, Komedia",
                link: "https://ebd.cda.pl/740x475/15359849b"
            }, {
                title: "Hot Shots 2",
                image: "https://filman.cc/public/static/poster/big/7781.jpg",
                year: "2022",
                genre: "Akcja",
                link: "https://sbchill.com/embed-2zh26ul71s0o.html"
            }],
            DruzynaA: [{
                title: "Drużyna A",
                image: "https://fwcdn.pl/fpo/02/90/190290/7331069.3.jpg",
                year: "2010",
                genre: "Komedia, Akcja",
                link: "https://upstream.to/embed-nsjjikyw58nx.html"
            }],


        };


const seriesMeta = {
  "TopGun": {
    description: "Legendarny duet pilotów łączący nostalgię z nowoczesną dawką adrenaliny.",
    mood: "Lotnicza akcja",
    highlight: "Rozpocznij od Top Gun: Maverick i poczuj klimat kokpitu.",
  },
  "SzybcyIWściekli": {
    description: "Rodzina, pościgi i nitro – ta seria podkręci każdy wieczór.",
    mood: "Szybkie tempo",
    highlight: "Zacznij od pierwszej części i szykuj przekąski na całą noc.",
  },
  "JohnWick": {
    description: "Elegancka, brutalna historia zemsty z mistrzowską choreografią walk.",
    mood: "Neo-noir",
    highlight: "Przygotuj się na balet walki – John Wick nie bierze jeńców.",
  },
  "Taxi": {
    description: "Francuska jazda bez trzymanki. Komediowy klasyk o szalonym taksówkarzu.",
    mood: "Komediowy sprint",
    highlight: "Każdy kurs to nowa dawka śmiechu i pościgów.",
  },
  "GodzinySzczytu": {
    description: "Buddy cop z humorem i akrobatyką Jackie Chana.",
    mood: "Buddy cop",
    highlight: "Lee i Carter gwarantują niekończące się one-linery.",
  },
  "ZabójczaBroń": {
    description: "Ikoniczny duet policjantów walczący z przestępczością Los Angeles.",
    mood: "Klasyczne kino akcji",
    highlight: "Riggs i Murtaugh udowadniają, że akcja nie zna wieku.",
  },
  "JasFasola": {
    description: "Slapstickowy humor idealny na rodzinny seans.",
    mood: "Rodzinny seans",
    highlight: "Mr. Bean zapewni salwy śmiechu niezależnie od wieku.",
  },
  "ZielonaMila": {
    description: "Poruszająca opowieść z nutą magii i refleksji.",
    mood: "Wzruszający dramat",
    highlight: "Zarezerwuj czas na spokojny, emocjonalny seans.",
  },
  "OjciecChrzestny": {
    description: "Gangsterska saga rodziny Corleone w najlepszym wydaniu.",
    mood: "Kultowy klasyk",
    highlight: "Witaj w rodzinie – to kino obowiązkowe.",
  },
  "BękartyWojny": {
    description: "Tarantino w alternatywnej historii II wojny światowej.",
    mood: "Tarantiński styl",
    highlight: "Błyskotliwe dialogi i zaskakujące zwroty gwarantowane.",
  },
  "Reacher": {
    description: "Serialowe śledztwa oparte na prozie Lee Childa.",
    mood: "Śledczy klimat",
    highlight: "Każdy odcinek to nowe miasto i nowa zagadka.",
  },
  "TowerHeistZemstaCieciów": {
    description: "Komediowy napad na penthouse pewnego finansisty.",
    mood: "Kryminalny humor",
    highlight: "Plan doskonały wymaga perfekcyjnej ekipy – masz ją tutaj.",
  },
  "HotShots": {
    description: "Parodia kina akcji puszczająca oko do Top Gun i Rambo.",
    mood: "Totalny odlot",
    highlight: "Charlie Sheen w kokpicie to przepis na dobrą zabawę.",
  },
  "_28Dni_Tygodni_Pozniej": {
    description: "Brytyjskie spojrzenie na apokalipsę zombie.",
    mood: "Postapokaliptyczne napięcie",
    highlight: "Sprawdź, jak Londyn radzi sobie po wybuchu epidemii.",
  },
  "_2012": {
    description: "Katastroficzne widowisko o końcu świata.",
    mood: "Katastroficzny rozmach",
    highlight: "Efekty specjalne na wielkim ekranie robią wrażenie.",
  },
  "Doomsday": {
    description: "Mroczne połączenie sci-fi i survivalu.",
    mood: "Postapokaliptyczna akcja",
    highlight: "Łączy klimat Mad Maxa z średniowiecznymi intrygami.",
  },
  "Uncharted": {
    description: "Filmowa adaptacja przygodowej serii gier.",
    mood: "Przygodowa akcja",
    highlight: "Skacz po dachach razem z Nathanem Drakiem.",
  }
};

const fallbackSeriesId = "TopGun";
const defaultMeta = {
  description: "Starannie wybrana kolekcja filmów przygotowana przez Maxa.",
  mood: "Filmowy wieczór",
  highlight: "Włącz pierwszy tytuł i daj się wciągnąć historii.",
};

const formatSeriesName = (id) => {
  return id
    .replace(/_/g, " ")
    .replace(/(\d+)([A-Z])/g, "$1 $2")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .replace(/([A-Z])([A-Z][a-z])/g, "$1 $2")
    .replace(/(\d+)/g, " $1")
    .replace(/DniTygodni/g, "Dni / Tygodni")
    .replace(/\b(\w)/g, (match) => match.toUpperCase())
    .trim();
};

const formatCountLabel = (count) => {
  if (count === 1) return "1 tytuł";
  if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) {
    return `${count} tytuły`;
  }
  return `${count} tytułów`;
};

const formatCollectionLabel = (count) => {
  return count === 1 ? "1 kolekcji" : `${count} kolekcjach`;
};

const computeDominantGenre = (items) => {
  const genreCounts = new Map();
  items.forEach(({ genre }) => {
    if (!genre) return;
    const parts = genre
      .split(/[,&/]/)
      .map((part) => part.trim())
      .filter(Boolean);
    parts.forEach((part) => {
      const key = part.toLowerCase();
      genreCounts.set(key, (genreCounts.get(key) ?? 0) + 1);
    });
  });
  if (!genreCounts.size) return "—";
  const [topGenre] = [...genreCounts.entries()].sort((a, b) => b[1] - a[1])[0];
  return topGenre.replace(/^./, (letter) => letter.toUpperCase());
};

const getSeriesMeta = (id) => {
  const meta = seriesMeta[id];
  if (!meta) return { ...defaultMeta };
  return {
    description: meta.description ?? defaultMeta.description,
    mood: meta.mood ?? defaultMeta.mood,
    highlight: meta.highlight ?? defaultMeta.highlight,
  };
};

document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const requestedSeriesId = params.get("series");
  const normalizedRequest = requestedSeriesId?.toLowerCase();
  let seriesId = requestedSeriesId ?? "";
  let isFallback = false;
  let isAllView = false;

  if (!requestedSeriesId) {
    isAllView = true;
    seriesId = "all";
  } else if (normalizedRequest === "all" || normalizedRequest === "wszystkie") {
    isAllView = true;
    seriesId = "all";
  } else if (!moviesData[seriesId]) {
    seriesId = fallbackSeriesId;
    isFallback = true;
  }

  const friendlyName = isAllView ? "Wszystkie filmy Maxa" : formatSeriesName(seriesId);
  const meta = isAllView
    ? {
        description: "Pełna biblioteka filmów ze wszystkich kolekcji Maxa.",
        mood: "Miks gatunków",
        highlight: "Przeglądaj wszystkie kolekcje w jednym miejscu i filtruj po tytułach.",
      }
    : getSeriesMeta(seriesId);
  const movies = isAllView
    ? Object.entries(moviesData).flatMap(([id, items = []]) => {
        const seriesName = formatSeriesName(id);
        return items.map((item) => ({
          ...item,
          seriesId: id,
          seriesName,
        }));
      })
    : (moviesData[seriesId] ?? []).map((movie) => ({
        ...movie,
        seriesId,
        seriesName: friendlyName,
      }));
  const collectionCount = Object.keys(moviesData).length;

  const heroTitle = document.querySelector("[data-series-title]");
  const heroDescription = document.querySelector("[data-series-description]");
  const heroHighlight = document.querySelector("[data-series-highlight]");
  const heroMeta = document.querySelector("[data-series-meta]");
  const heroCount = document.querySelector("[data-series-count]");
  const heroGenre = document.querySelector("[data-series-genre]");
  const heroMood = document.querySelector("[data-series-mood]");
  const primaryLink = document.querySelector("[data-series-primary]");
  const filterInput = document.querySelector("[data-film-filter]");
  const randomButtons = [
    document.querySelector("[data-film-random]"),
    document.querySelector("[data-series-random]")
  ].filter(Boolean);
  const container = document.querySelector("[data-series-container]");
  const emptyState = document.querySelector("[data-film-empty]");
  const sectionTitle = document.querySelector("[data-series-section-title]");
  const sectionDescription = document.querySelector("[data-series-section-description]");
  const suggestionsContainer = document.querySelector("[data-series-suggestions]");

  if (heroTitle) {
    heroTitle.textContent = friendlyName;
  }

  if (heroDescription) {
    if (isFallback) {
      heroDescription.textContent = "Nie znaleźliśmy takiej kolekcji, dlatego proponujemy sprawdzony zestaw Top Gun.";
    } else if (isAllView) {
      heroDescription.textContent = `Przeglądasz ${formatCountLabel(movies.length)} w ${formatCollectionLabel(collectionCount)}. Użyj wyszukiwarki, aby szybko odnaleźć ulubione tytuły.`;
    } else {
      heroDescription.textContent = `${meta.description} Liczba tytułów: ${formatCountLabel(movies.length)}.`;
    }
  }

  if (sectionTitle) {
    sectionTitle.textContent = isAllView ? "Pełny katalog filmów" : `Tytuły z kolekcji ${friendlyName}`;
  }

  if (sectionDescription) {
    sectionDescription.textContent = isAllView
      ? "Cała biblioteka filmów Maxa w jednym miejscu. Filtruj po tytułach, gatunkach lub nazwach kolekcji."
      : 'Kliknij w przycisk „Oglądaj”, aby uruchomić film w nowym oknie. Możesz też filtrować po tytułach i gatunkach.';
  }

  const baseHighlight = isFallback
    ? "Nie znaleziono wskazanej kolekcji. Pokazujemy sprawdzony zestaw Top Gun."
    : meta.highlight;

  const applySeriesMessage = (message) => {
    if (heroHighlight) {
      heroHighlight.textContent = message;
    }
  };

  applySeriesMessage(baseHighlight);

  if (heroMeta) {
    heroMeta.textContent = isAllView
      ? `${formatCountLabel(movies.length)} w ${formatCollectionLabel(collectionCount)}`
      : formatCountLabel(movies.length);
  }

  if (heroCount) {
    heroCount.textContent = String(movies.length);
  }

  if (heroGenre) {
    heroGenre.textContent = computeDominantGenre(movies);
  }

  if (heroMood) {
    heroMood.textContent = meta.mood;
  }

  if (primaryLink) {
    const firstMovie = movies[0];
    if (firstMovie) {
      primaryLink.textContent = `Oglądaj ${firstMovie.title}`;
      primaryLink.setAttribute("href", firstMovie.link);
      primaryLink.setAttribute("target", "_blank");
      primaryLink.setAttribute("rel", "noopener");
    } else {
      primaryLink.textContent = "Wróć do listy";
    }
  }

  document.title = `${friendlyName} – Kolekcja filmowa Max Playground`;

  if (!container) {
    return;
  }

  container.innerHTML = "";

  const applyMovieHighlight = (movie) => {
    const seriesMessage = isAllView && movie.seriesName ? ` z kolekcji ${movie.seriesName}` : "";
    applySeriesMessage(`Włącz ${movie.title} (${movie.year})${seriesMessage} – ${movie.genre}.`);
  };

  const cardEntries = movies.map((movie) => {
    const card = document.createElement("article");
    card.className = "media-card media-card--compact";
    card.dataset.title = movie.title.toLowerCase();
    card.dataset.tags = (movie.genre ?? "").toLowerCase();
    card.dataset.series = (movie.seriesName ?? "").toLowerCase();
    card.setAttribute("data-film-card", "");
    card.innerHTML = `
      <figure class="media-card__poster media-card__poster--compact">
        <img src="${movie.image}" alt="Plakat filmu ${movie.title}" loading="lazy">
      </figure>
      <div class="media-card__body">
        <h3>${movie.title}</h3>
        <div class="media-card__meta">
          <span>${movie.year}</span>
          <span>${movie.genre}</span>
        </div>
        ${isAllView ? `<div class="media-card__tags"><span>${movie.seriesName}</span></div>` : ""}
        <a class="btn btn-primary" href="${movie.link}" target="_blank" rel="noopener">Oglądaj</a>
      </div>
    `;
    card.addEventListener("mouseenter", () => applyMovieHighlight(movie));
    card.addEventListener("focusin", () => applyMovieHighlight(movie));
    container.appendChild(card);
    return { card, movie };
  });

  const filterMovies = () => {
    const query = filterInput?.value.trim().toLowerCase() ?? "";
    let visibleCount = 0;
    cardEntries.forEach(({ card }) => {
      const haystack = `${card.dataset.title ?? ""} ${card.dataset.tags ?? ""} ${card.dataset.series ?? ""}`;
      const isVisible = haystack.includes(query);
      card.classList.toggle("is-hidden", !isVisible);
      if (isVisible) {
        visibleCount += 1;
      }
    });
    const hasResults = visibleCount > 0;
    emptyState?.classList.toggle("is-visible", !hasResults);
    if (!hasResults) {
      applySeriesMessage("Brak wyników dla tego filtra. Spróbuj innego gatunku lub tytułu.");
    } else if (!query) {
      applySeriesMessage(baseHighlight);
    }
  };

  filterInput?.addEventListener("input", filterMovies);

  const pickRandomFilm = () => {
    const visibleEntries = cardEntries.filter(({ card }) => !card.classList.contains("is-hidden"));
    if (!visibleEntries.length) {
      randomButtons.forEach((button) => button?.classList.add("shake"));
      window.setTimeout(() => randomButtons.forEach((button) => button?.classList.remove("shake")), 600);
      return;
    }
    const { card, movie } = visibleEntries[Math.floor(Math.random() * visibleEntries.length)];
    card.classList.add("is-highlighted");
    card.scrollIntoView({ behavior: "smooth", block: "center" });
    applyMovieHighlight(movie);
    const link = card.querySelector("a");
    link?.focus({ preventScroll: true });
    window.setTimeout(() => card.classList.remove("is-highlighted"), 2600);
  };

  randomButtons.forEach((button) => {
    button?.addEventListener("click", pickRandomFilm);
  });

  const renderSuggestions = () => {
    if (!suggestionsContainer) return;
    if (isAllView) {
      const suggestionsSection = suggestionsContainer.closest("section");
      suggestionsSection?.classList.add("is-hidden");
      return;
    }
    suggestionsContainer.innerHTML = "";
    const availableSeries = Object.keys(moviesData).filter((id) => id !== seriesId);
    availableSeries.sort(() => Math.random() - 0.5);
    availableSeries.slice(0, 3).forEach((id) => {
      const items = moviesData[id];
      if (!items?.length) return;
      const suggestionMeta = getSeriesMeta(id);
      const suggestionName = formatSeriesName(id);
      const card = document.createElement("article");
      card.className = "media-card media-card--mini";
      card.innerHTML = `
        <figure class="media-card__poster media-card__poster--mini">
          <img src="${items[0].image}" alt="Plakat kolekcji ${suggestionName}" loading="lazy">
        </figure>
        <div class="media-card__body">
          <h3>${suggestionName}</h3>
          <p>${suggestionMeta.description}</p>
          <a class="btn btn-secondary" href="movies.html?series=${encodeURIComponent(id)}">Zobacz kolekcję</a>
        </div>
      `;
      suggestionsContainer.appendChild(card);
    });
  };

  renderSuggestions();
  filterMovies();

  if (cardEntries.length && !isFallback) {
    applyMovieHighlight(cardEntries[0].movie);
  }
});
